name: Get_Solution_Get_Branch_And_Commit

on:
  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:
    inputs:
      solution-name: 
        required: true
      dynamic_branch:
        description: Select branch
        required: true
        type: dynamic_branch
        default: main

jobs:
  build:
    runs-on: windows-latest

    permissions:
      # Give the default GITHUB_TOKEN write permission to commit and push the
      # added or changed files to the repository.
      contents: write
      
    steps:
      - name: Set multiple variables
        run: |
          $sum=$((1 + 2))
          $result=$((1 + 3))
          echo "sum=$sum" >> $GITHUB_ENV
          echo "result=$result" >> $GITHUB_ENV

      - name: Use the sum variable
        run: |
          echo "The sum of 1 + 2 is ${{ env.sum }}"

      - name: Use the result variable
        run: |
          echo "The result of (1 + 2) * 3 is ${{ env.result }}"
    
      # install pac
      - name: install pac
        run: |
          dotnet tool install --global Microsoft.PowerApps.CLI.Tool   
          
      - name: export solution
        run: |       
          pac auth create --applicationId ${{ secrets.APP_ID }} --clientSecret '${{ secrets.CLIENT_SECRET }}' -t '${{ secrets.TENANT_ID }}' --environment '${{ secrets.ENV }}'
          $workingFolder='${{ github.event.inputs.solution-name }}'
          $solutionName='${{ github.event.inputs.solution-name }}'
          $zipFile = ".\$solutionName\$solutionName.zip"
          
          pac solution export --name $solutionName --path .\$solutionName --overwrite
          #unpack solution
          pac solution unpack --zipfile $zipFile --folder $workingFolder --processCanvasApps
          echo "path=${{ github.workspace }}" >> $GITHUB_OUTPUT

      - name: get branch and commit id
        id: extractRepoValues
        run: |
          $folderPath='.\${{ github.event.inputs.solution-name }}\organizationsettings\dd_branchName'
          $fileName='organizationsetting.xml'
          $childNodeName='value'
          
          $xmlFilePath = Get-ChildItem -Path $folderPath -Recurse -Filter $fileName | Select-Object -ExpandProperty FullName -First 1
          [xml]$xml = Get-Content -Path $xmlFilePath
          
          # Find the node with the specified attribute value
          $node = $xml.SelectSingleNode("//value")
          
          $node.innerText
          #echo "branch=$($node.innerText)" >> $GITHUB_OUTPUT
          
          $folderPath='.\${{ github.event.inputs.solution-name }}\organizationsettings\dd_commitReference'
          $fileName='organizationsetting.xml'
          $childNodeName='value'
          
          $xmlFilePath = Get-ChildItem -Path $folderPath -Recurse -Filter $fileName | Select-Object -ExpandProperty FullName -First 1
          [xml]$xml = Get-Content -Path $xmlFilePath
          
          # Find the node with the specified attribute value
          $node = $xml.SelectSingleNode("//value")
          
          $node.innerText
          echo "commitReference=$($node.innerText)" >> $GITHUB_OUTPUT
          echo "commitReference=$node.innerText" >> $GITHUB_ENV
          

      - name: testOutput
        run: |
          echo '${{ steps.extractRepoValues.outputs.branch }}'
          echo '${{ env.commitReference }}'
          
      - name: Set color
        id: random-color-generator
        run: echo "SELECTED_COLOR=green" >> $GITHUB_OUTPUT
      - name: Get color
        run: echo "The selected color is ${{ steps.random-color-generator.outputs.SELECTED_COLOR }}"          

